- **Scalability**: Ability of a system to handle higher loads by adapting 
- There are two types of scalability: **vertical** and **horizontal (elasticity)**

## Vertical Scalability

- Means increasing **size of instance** 
	- Converting from a t2.micro -> t2.large 
- Common for databases and other **non-distributed systems**
	- AWS services that scale vertically are **RDS** and **ElastiCache**
	- Usually a hardware limit in how much you can vertically scale

## Horizontal Scalability 

- Means increasing **number of instances**
	- Common for **web apps**
- Much easier to horizontally scale using stuff like [[3. Amazon EC2 Fundamentals|EC2]] 
	- Auto Scaling Group 
	- Load Balancer

## High Availability

^410dd2

- Usually associated with **horizontal scaling**
- Needed to survive data center loss -- means running system in >=2 [[1. Getting Started with AWS#^542f5c|AZs]]
- High availability can either be **passive** (RDS Multi AZ) or **active** (horizontal scaling)
- For EC2: 
	- Auto Scaling Group (multi AZ)
	- Load Balancer (multi AZ)

## Load Balancing

- **Load Balancers** are servers that forward traffic to multiple servers and balance traffic between them 

![[Pasted image 20240927144309.png]]

- Load balancers are useful for many reasons: 
	- Allows load spread across multiple instances
	- Exposes a **single point of access** to app (DNS)
	- Allows for failure handling of downstream instances 
		- Regular health checks
	- High Availability across zones 
	- Separate public/private traffic

### Elastic Load Balancers 

- **Elastic Load Balancers** are managed load balancers; this means that
	- It will always be working
	- Takes care of upgrades/maintenance/availability
	- Hard to customize though 
	- Integrated with (a lot of stuff): 
		- EC2, EC2 Autoscaling Groups, Amazon ECS 
		- AWS Certificate Manager, Cloudwatch
		- Route 53, AWS WAF, AWS Global Accelerator
- **Health Checks** allow load balancers to check if the instances they're forwarding traffic to work 
	- Health checks are usually done on a port/route (usually **/health**)
		- Anything **other than 200 (OK)** means something's **wrong**
- There are **4 types** of managed load balancers: 
	- **Classic Load Balancer** (old) ^e95f54
		- HTTP/HTTPS/TCP/SSL
		- Health checks are TCP/HTTP based
		- Fixed hostname **XXX.region.elb.amazonaws.com**
	- **Application Load Balancer** ^f60d27
		- HTTP/HTTPS/WebSocket
		- Load balancing to apps across machines/same machine
		- Supports redirects
		- Can route based on several things: 
			- URL path (example.com/users)
			- URL hostname (**one**.example.com)
			- Query string/headers (example.com/useres?id=123&order=false)
		- Good for microservices
		- Port mapping feature to redirect to a dynamic port 
			- This would need multiple CLBs per app
		- **Target Groups**
			- EC2 Instances -- HTTP 
			- ECS tasks -- HTTP
			- Lambda functions -- HTTP -> JSON
			- IP Addresses -- private IPs
			- ALB can route to multiple target groups
			- **Health checks** take place at target group level 
		- Fixed host name **XXX.region.elb.amazonaws.com**
		- App servers **don't see client IP directly** -- Instead, it's inserted in **X-Forwarded-For** header
		- Port/proto is stored in headers **X-Forwarded-Port** and **X-Forwarded-Proto**

![[Pasted image 20240927155221.png]]
	- **Network Load Balancer**
		- TCP/TLS/UDP
		- Handles millions o/ requests per s
		- Less latency 
		- **One static ip/AZ**, but supports assigning an elastic IP 
		- Used for **extreme performance** and **TCP/UDP traffic**
		- **Not included** in AWS Free Tier
		- Target groups for an NLB can include: 
			- EC2 instances
			- (Private) IPs
			- ALBs 
		- Health checks support TCP/HTTP/HTTPS
![[Pasted image 20240927155626.png]]
	- **Gateway Load Balancer**
		- Layer 3 (IP Protocol)
		- Used to manage network virtual appliances in AWS
			- Firewalls, Intrusion Detection, security stuff
		- Ensures a single entry/exit for all traffic and distributes traffic to all virtual apps
		- Uses **GENEVE** protocol on port 6081
		- Target groups in a GLB can include:
			- EC2 instances
			- (Private) IPs ^2e8df9
- Load balancers can be setup as **internal (private)** or **external (public)**

## Sticky Sessions 

- **Sticky sessions** ensure that a client is *always* redirected to same instance
	- Works for CLBs, ALBs, and NLBs (**not GLBs**)
	- For CLB and ALB, there is a **cookie** used for stickiness with a (controllable) expiration date
		- Used to make sure that a user doesn't lose session data
	- However, **may imbalance load**
- **Cookie Names**
	- Application-based Cookies
		- **Custom cookie**
			- Generated by **target**
			- Includes any custom attributes required by app 
			- **Cannot use AWSALB, AWSALBAPP, AWSALBTG**
		- **Application Cookie**
			- Generated by the load balancer
			- Cookie name is **AWSALBAPP** 
	- Duration-Based Cookies
		- Generated by load balancer
		- Cookie name is AWSALB for ALB, AWSELB for CLB

## Cross-Zone Load Balancing

- Application Load Balancer
	- Enabled by default
	- Free
- NLB, GLB
	- Disabled by default
	- Costs money 
- CLB
	- Disabled by default
	- Free

## SSL/TLS

- **SSL Certificate**: Allows traffic between clients and LB to be encrypted
	- SSL (Secure Sockets Layer)
	- TLS (Transport Layer Security) -- newer
		- Usually used, but SSL sometimes
	- SSL certs are issued by Certificate Authorities like Godaddy -- have an expiration date and must be renewed
	- Load Balancer uses **X.509** cert
		- Certs are managed using AWS Certificate Manager
		- You can also upload your own certs
- **Server Name Indication (SNI)**: Allows loading of multiple SSL certs for multiple sites
	- Requires hostname of target server
	- Only works for ALB, NLB (**NOT GLB OR CLB**)
- **Connection Draining (or Deregistration Delay for ALB+NLB)**
	- Time to complete requests while the instance is unhealthy
	- Stops sending new requests to unhealthy EC2 instance
		- 1-3600s
	- If set to 0, connection draining is disabled
	- If requests are **short**, you should set this to a **low value**

## Auto Scaling Group

- **Auto Scaling Groups** help with scaling servers to match load: 
	- Scale out/in EC2 instances to match loads
	- Have a min/max number of instances running
	- Add new instances to load balancer
	- Recreate instances in case of termination
	- These are **free!!**
- **Templates for ASGs:**
	- AMI + Instance Type
	- EC2 User Data
	- EBS Volumes
	- Security Groups
	- SSH Key/pair
	- IAM Roles
	- Network + Subnets info 
	- Load Balancer info
- Min/Max Size, Initial Capacity
- Scaling policies

- You can scale ASG based on **Cloudwatch alarms**
	- Alarms monitor metrics and scale in/out based on them 

### Scaling Policies

- **Dynamic Scaling**: (want the average ASG CPU ~= 40%)
	- When an alarm is triggered, add/remote units
- **Scheduled Scaling**: Scale based on usage patterns
- **Predictive Scaling**: Continuously forecast load and schedule scaling based on it
- You should scale on metrics like: 
	- CPU Utilization
	- Request Count/Target
	- Average Network In?out
	- Custom metric
- **Scaling Cooldowns**: Time after scaling activity that the ASG can't scale
	- To reduce this, use an AMI 
- **Instance Refresh**: Update launch template and recreate EC2 instances
	- If minimum healthy percentage is not met, execute instance refresh 

